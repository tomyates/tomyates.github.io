import{SoundMeter}from"./soundmeter.js";export class MediaManager{constructor(e){for(var t in this.bandwidth=900,this.debug=!1,this.camera_location="top",this.camera_margin=15,this.camera_percent=15,this.mediaConstraints=null,this.getSender=e.getSender,this.publishStreamId=null,e.userParameters)e.userParameters.hasOwnProperty(t)&&(this[t]=e.userParameters[t]);this.currentVolume=null,this.previousAudioTrack=null,this.desktopStream=null,this.smallVideoTrack=null,this.audioContext=new AudioContext,this.primaryAudioTrackGainNode=null,this.secondaryAudioTrackGainNode=null,this.localStream=null,this.blackFrameTimer=null,this.mutedAudioStream=null,this.isMuted=!1,this.meterRefresh=null,this.localVideo=document.getElementById(this.localVideoId),this.dummyCanvas=document.createElement("canvas"),this.soundLevelProviderId=-1,this.publishMode="camera","camera"==this.mediaConstraints.video?this.publishMode="camera":"screen"==this.mediaConstraints.video?this.publishMode="screen":"screen+camera"==this.mediaConstraints.video&&(this.publishMode="screen+camera"),this.checkBrowserScreenShareSupported()}initLocalStream(){if(this.checkWebRTCPermissions(),this.getDevices(),this.trackDeviceChange(),void 0!==this.mediaConstraints.video&&0!=this.mediaConstraints.video)this.openStream(this.mediaConstraints,this.mode);else{var e={audio:this.mediaConstraints.audio};this.navigatorUserMedia(e,(e=>{this.gotStream(e)}),!0)}}checkWebRTCPermissions(){return"WebSocket"in window?void 0===navigator.mediaDevices?(console.log("Cannot open camera and mic because of unsecure context. Please Install SSL(https)"),void this.callbackError("UnsecureContext")):void(void 0!==navigator.mediaDevices&&null!=navigator.mediaDevices&&null!=navigator.mediaDevices||this.callbackError("getUserMediaIsNotAllowed")):(console.log("WebSocket not supported."),void this.callbackError("WebSocketNotSupported"))}getDevices(){navigator.mediaDevices.enumerateDevices().then((e=>{let t=new Array,i=!1,a=!1;e.forEach((e=>{"audioinput"!=e.kind&&"videoinput"!=e.kind||(t.push(e),"audioinput"==e.kind&&(i=!0),"videoinput"==e.kind&&(a=!0))})),this.callback("available_devices",t),0==i&&null==this.localStream&&(console.log("Audio input not found"),console.log("Retrying to get user media without audio"),this.inputDeviceNotFoundLimit<2?0!=a?(this.openStream({video:!0,audio:!1},this.mode),this.inputDeviceNotFoundLimit++):(console.log("Video input not found"),alert("There is no video or audio input")):alert("No input device found, publish is not possible"))})).catch((e=>{console.error("Cannot get devices -> error name: "+e.name+": "+e.message)}))}trackDeviceChange(){navigator.mediaDevices.ondevicechange=()=>{this.getDevices()}}setDesktopwithCameraSource(e,t,i){this.desktopStream=e,this.navigatorUserMedia({video:!0,audio:!1},(a=>{this.smallVideoTrack=a.getVideoTracks()[0];var o=document.createElement("canvas"),r=o.getContext("2d"),s=document.createElement("video");s.srcObject=e,s.play();var d=document.createElement("video");d.srcObject=a,d.play();var n=o.captureStream(15);null==this.localStream?this.gotStream(n):this.updateVideoTrack(n,t,onended,null),null!=i&&(e.getVideoTracks()[0].onended=function(e){i(e)}),setInterval((()=>{o.width=s.videoWidth,o.height=s.videoHeight,r.drawImage(s,0,0,o.width,o.height);var e,t=s.videoWidth*(this.camera_percent/100),i=d.videoHeight/d.videoWidth*t,a=o.width-t-this.camera_margin;e="top"==this.camera_location?this.camera_margin:o.height-i-this.camera_margin,r.drawImage(d,a,e,t,i)}),66)}),!0)}prepareStreamTracks(e,t,i,a){var o=i.getAudioTracks();if(o.length>0&&"camera"==this.publishMode&&(o[0].stop(),i.removeTrack(o[0])),"undefined"!=t&&0!=t){var r={audio:t};this.navigatorUserMedia(r,(r=>{r=this.setGainNodeStream(r);var s=t=>{this.callback("screen_share_stopped"),this.setVideoCameraSource(a,e,null,!0)};"screen"==this.publishMode?(this.updateVideoTrack(i,a,s,!0),o.length>0&&(r=this.mixAudioStreams(i,r)),this.updateAudioTrack(r,a,null)):"screen+camera"==this.publishMode?(o.length>0&&(r=this.mixAudioStreams(i,r)),this.updateAudioTrack(r,a,null),this.setDesktopwithCameraSource(i,a,s)):(0!=t&&null!=t&&i.addTrack(r.getAudioTracks()[0]),this.gotStream(i))}),!0)}else this.gotStream(i)}navigatorUserMedia(e,t,i){1==i?navigator.mediaDevices.getUserMedia(e).then(t).catch((e=>{"NotFoundError"==e.name?this.getDevices():this.callbackError(e.name,e.message)})):navigator.mediaDevices.getUserMedia(e).then(t)}navigatorDisplayMedia(e,t){navigator.mediaDevices.getDisplayMedia(e).then(t).catch((e=>{"NotAllowedError"===e.name&&(console.debug("Permission denied error"),this.callbackError("ScreenSharePermissionDenied"),null==this.localStream?this.openStream({video:!0,audio:!0}):this.switchVideoCameraCapture(streamId))}))}getMedia(e,t,i){"screen+camera"==this.publishMode||"screen"==this.publishMode?this.navigatorDisplayMedia(e,(a=>{this.smallVideoTrack&&this.smallVideoTrack.stop(),this.prepareStreamTracks(e,t,a,i)})):this.navigatorUserMedia(e,(a=>{this.smallVideoTrack&&this.smallVideoTrack.stop(),this.prepareStreamTracks(e,t,a,i)}),!0)}openStream(e){this.mediaConstraints=e;var t=!1;void 0!==e.audio&&0!=e.audio&&(t=e.audio),void 0!==e.video?this.getMedia(e,t):(console.error("MediaConstraint video is not defined"),this.callbackError("media_constraint_video_not_defined"))}closeStream(){this.localStream.getVideoTracks().forEach((function(e){e.onended=null,e.stop()})),this.localStream.getAudioTracks().forEach((function(e){e.onended=null,e.stop()})),null!==this.videoTrack&&this.videoTrack.stop(),null!==this.audioTrack&&this.audioTrack.stop(),null!==this.smallVideoTrack&&this.smallVideoTrack.stop(),this.previousAudioTrack&&this.previousAudioTrack.stop(),-1!=this.soundLevelProviderId&&(clearInterval(this.soundLevelProviderId),this.soundLevelProviderId=-1)}checkBrowserScreenShareSupported(){(void 0!==navigator.mediaDevices&&navigator.mediaDevices.getDisplayMedia||navigator.getDisplayMedia)&&this.callback("browser_screen_share_supported")}enableSecondStreamInMixedAudio(e){null!=this.secondaryAudioTrackGainNode&&(this.secondaryAudioTrackGainNode.gain.value=e?1:0)}gotStream(e){this.localStream=e,this.localVideo&&(this.localVideo.srcObject=e)}enableAudioLevelWhenMuted(){navigator.mediaDevices.getUserMedia({video:!1,audio:!0}).then((e=>{this.mutedAudioStream=e;const t=new SoundMeter(this.audioContext);t.connectToSource(this.mutedAudioStream,(e=>{e?alert(e):this.meterRefresh=setInterval((()=>{t.instant.toFixed(2)>.1&&this.callback("speaking_but_muted")}),200)}))})).catch((function(e){console.log("Can't get the soundlevel on mute")}))}disableAudioLevelWhenMuted(){null!=this.meterRefresh&&clearInterval(this.meterRefresh),null!=this.mutedAudioStream&&this.mutedAudioStream.getTracks().forEach((function(e){e.stop()}))}mixAudioStreams(e,t){var i=new MediaStream;e.getVideoTracks().forEach((function(e){i.addTrack(e)})),this.audioContext=new AudioContext;var a=this.audioContext.createMediaStreamDestination();return e.getAudioTracks().length>0?(this.primaryAudioTrackGainNode=this.audioContext.createGain(),this.primaryAudioTrackGainNode.gain.value=1,this.audioContext.createMediaStreamSource(e).connect(this.primaryAudioTrackGainNode).connect(a)):console.debug("Origin stream does not have audio track"),t.getAudioTracks().length>0?(this.secondaryAudioTrackGainNode=this.audioContext.createGain(),this.secondaryAudioTrackGainNode.gain.value=1,this.audioContext.createMediaStreamSource(t).connect(this.secondaryAudioTrackGainNode).connect(a)):console.debug("Second stream does not have audio track"),a.stream.getAudioTracks().forEach((function(e){i.addTrack(e),console.log("audio destination add track")})),i}setGainNodeStream(e){if(0!=this.mediaConstraints.audio&&void 0!==this.mediaConstraints.audio){const t=e.getVideoTracks(),i=e.getAudioTracks();this.audioContext=new AudioContext;let a=this.audioContext.createMediaStreamSource(e),o=this.audioContext.createMediaStreamDestination();this.primaryAudioTrackGainNode=this.audioContext.createGain(),a.connect(this.primaryAudioTrackGainNode),this.primaryAudioTrackGainNode.connect(o),null==this.currentVolume?this.primaryAudioTrackGainNode.gain.value=1:this.primaryAudioTrackGainNode.gain.value=this.currentVolume;const r=o.stream;for(const e of t)r.addTrack(e);for(const e of i)r.addTrack(e);return null!==this.previousAudioTrack&&this.previousAudioTrack.stop(),this.previousAudioTrack=r.getAudioTracks()[1],r}return e}switchDesktopCapture(e){this.publishMode="screen";var t=!1;void 0!==this.mediaConstraints.audio&&0!=this.mediaConstraints.audio&&(t=this.mediaConstraints.audio),void 0!==this.mediaConstraints.video&&0!=this.mediaConstraints.video&&(this.mediaConstraints.video=!0),this.getMedia(this.mediaConstraints,t,e)}switchDesktopCaptureWithCamera(e){void 0!==this.mediaConstraints.video&&0!=this.mediaConstraints.video&&(this.mediaConstraints.video=!0),this.publishMode="screen+camera";var t=!1;void 0!==this.mediaConstraints.audio&&0!=this.mediaConstraints.audio&&(t=this.mediaConstraints.audio),this.getMedia(this.mediaConstraints,t,e)}updateLocalAudioStream(e,t){var i=e.getAudioTracks()[0];if(null!=this.localStream&&null!=this.localStream.getAudioTracks()[0]){var a=this.localStream.getAudioTracks()[0];this.localStream.removeTrack(a),a.stop(),this.localStream.addTrack(i)}else null!=this.localStream?this.localStream.addTrack(i):this.localStream=e;null!=this.localVideo&&(this.localVideo.srcObject=this.localStream),null!=t&&(e.getAudioTracks()[0].onended=function(e){t(e)}),this.isMuted?this.muteLocalMic():this.unmuteLocalMic()}updateLocalVideoStream(e,t,i){i&&null!=this.desktopStream&&this.desktopStream.getVideoTracks()[0].stop();var a=e.getVideoTracks()[0];if(null!=this.localStream&&null!=this.localStream.getVideoTracks()[0]){var o=this.localStream.getVideoTracks()[0];this.localStream.removeTrack(o),o.stop(),this.localStream.addTrack(a)}else null!=this.localStream?this.localStream.addTrack(a):this.localStream=e;this.localVideo&&(this.localVideo.srcObject=this.localStream),null!=t&&(e.getVideoTracks()[0].onended=function(e){t(e)})}switchAudioInputSource(e,t){var i=this.localStream.getAudioTracks()[0];if(i?i.stop():console.warn("There is no audio track in local stream"),void 0!==t){!0!==this.mediaConstraints.audio?this.mediaConstraints.audio.deviceId=t:this.mediaConstraints.audio={deviceId:t};let i={video:!1,audio:{deviceId:t}};this.setAudioInputSource(e,i,null,!0,t)}else this.setAudioInputSource(e,this.mediaConstraints,null,!0,t)}setAudioInputSource(e,t,i){this.navigatorUserMedia(t,(a=>{a=this.setGainNodeStream(a),this.updateAudioTrack(a,e,t,i)}),!0)}switchVideoCameraCapture(e,t,i){var a=this.localStream.getVideoTracks()[0];a?a.stop():console.warn("There is no video track in local stream"),this.publishMode="camera",navigator.mediaDevices.enumerateDevices().then((i=>{for(let e=0;e<i.length;e++)if("videoinput"==i[e].kind&&i[e].deviceId==t){!0!==this.mediaConstraints.video?this.mediaConstraints.video.deviceId={exact:t}:this.mediaConstraints.video={deviceId:{exact:t}};break}console.debug("Given deviceId = "+t+" - Media constraints video property = "+this.mediaConstraints.video),this.setVideoCameraSource(e,this.mediaConstraints,null,!0,t)}))}setVideoCameraSource(e,t,i,a){this.navigatorUserMedia(t,(o=>{a&&this.secondaryAudioTrackGainNode&&(this.secondaryAudioTrackGainNode=null,o=this.setGainNodeStream(o),this.updateAudioTrack(o,e,t,i)),this.updateVideoTrack(o,e,i,a)}),!0)}updateAudioTrack(e,t,i){var a=this.getSender(t,"audio");a?a.replaceTrack(e.getAudioTracks()[0]).then((t=>{this.updateLocalAudioStream(e,i)})).catch((function(e){console.log(e.name)})):this.updateLocalAudioStream(e,i)}updateVideoTrack(e,t,i,a){var o=this.getSender(t,"video");o?o.replaceTrack(e.getVideoTracks()[0]).then((t=>{this.updateLocalVideoStream(e,i,a)})).catch((e=>{console.log(e.name)})):this.updateLocalVideoStream(e,i,a)}initializeDummyFrame(){this.dummyCanvas.getContext("2d").fillRect(0,0,320,240),this.replacementStream=this.dummyCanvas.captureStream()}turnOffLocalCamera(e){if(this.initializeDummyFrame(),null!=this.localStream){let t;t=null!=e||void 0!==e?e:this.publishStreamId,this.updateVideoTrack(this.replacementStream,t,null,!0)}else this.callbackError("NoActiveConnection");null==this.blackFrameTimer&&(this.blackFrameTimer=setInterval((()=>{this.initializeDummyFrame()}),3e3))}turnOnLocalCamera(e){null!=this.blackFrameTimer&&(clearInterval(this.blackFrameTimer),this.blackFrameTimer=null),null==this.localStream?this.navigatorUserMedia(this.mediaConstraints,(e=>{this.gotStream(e)}),!1):this.navigatorUserMedia(this.mediaConstraints,(t=>{let i;i=null!=e||void 0!==e?e:this.publishStreamId,this.updateVideoTrack(t,i,null,!0)}),!1)}muteLocalMic(){this.isMuted=!0,null!=this.localStream?this.localStream.getAudioTracks().forEach((e=>e.enabled=!1)):this.callbackError("NoActiveConnection")}unmuteLocalMic(){this.isMuted=!1,null!=this.localStream?this.localStream.getAudioTracks().forEach((e=>e.enabled=!0)):this.callbackError("NoActiveConnection")}getVideoSender(e){var t=null;return"undefined"!=typeof adapter&&null!==adapter&&("chrome"===adapter.browserDetails.browser||"firefox"===adapter.browserDetails.browser||"safari"===adapter.browserDetails.browser&&adapter.browserDetails.version>=64)&&"RTCRtpSender"in window&&"setParameters"in window.RTCRtpSender.prototype&&(t=this.getSender(e,"video")),t}changeBandwidth(e,t){var i=this.getVideoSender(t);if(null!=i){const t=i.getParameters();return t.encodings||(t.encodings=[{}]),"unlimited"===e?delete t.encodings[0].maxBitrate:t.encodings[0].maxBitrate=1e3*e,i.setParameters(t)}return"Video sender not found to change bandwidth. Streaming may not be active",Promise.reject("Video sender not found to change bandwidth. Streaming may not be active")}setVolumeLevel(e){this.currentVolume=e,null!=this.primaryAudioTrackGainNode&&(this.primaryAudioTrackGainNode.gain.value=e),null!=this.secondaryAudioTrackGainNode&&(this.secondaryAudioTrackGainNode.gain.value=e)}enableAudioLevelForLocalStream(e,t){const i=new SoundMeter(this.audioContext);i.connectToSource(this.localStream,(function(e){e?alert(e):console.log("Added sound meter for stream: "+streamId+" = "+i.instant.toFixed(2))})),this.soundLevelProviderId=setInterval((()=>{e(i.instant.toFixed(2))}),t)}}