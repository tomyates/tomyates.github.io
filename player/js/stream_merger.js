export class StreamMerger{constructor(t,e,i,h){this.streams=[],this.width=t,this.height=e;const s=window.AudioContext||window.webkitAudioContext;this.audioCtx=new s,this.audioDestination=this.audioCtx.createMediaStreamDestination(),this.autoMode=i,this.aspectRatio=h,this.stream_height=e,this.stream_width=t,this.pwidth=0,this.pheight=0,this.vwidth=0,this.wheight=0,this.canvas=document.createElement("canvas"),this.canvas.setAttribute("width",this.width),this.canvas.setAttribute("height",this.height),this.ctx=this.canvas.getContext("2d"),this.streamCount=0,this.frameCount=0,this.videoSyncDelayNode=this.audioCtx.createDelay(5),this.videoSyncDelayNode.connect(this.audioDestination),this.started=!1,this.fps=30}changeAspectRatio(t){this.aspectRatio=t,console.log("Changing aspect ratio to: "+t),this.resizeAndSortV2()}changeStreamSize(t){this.stream_height=t,console.log("Changing merged streams size to = "+t+"p"),this.resizeAndSortV2()}getResult(){return this.result}addStream(t,e){this.streamCount++;const i={};this.audioCtx.resume(),i.streamId=e.streamId,i.width=e.width||150,i.height=e.height||150,i.Xindex=e.Xindex||0,i.Yindex=e.Yindex||0,i.portrait=!1,i.aspectRatio=4/3,null==e.x?i.x=i.width*i.Xindex:i.x=e.x,null==e.x?i.y=i.height*i.Yindex:i.y=e.y,console.debug(i.width,i.Xindex,i.x),i.mute=e.mute||!1;let h=null;h=document.createElement("video"),h.autoplay=!0,h.muted=!0,h.srcObject=t,h.setAttribute("style","position:fixed; left: 0px; top:0px; display: none pointer-events: none; opacity:0;"),document.body.appendChild(h),i.mute||(i.audioSource=this.audioCtx.createMediaStreamSource(t),i.audioGainNode=this.audioCtx.createGain(),i.audioGainNode.gain.value=1,i.audioSource.connect(i.audioGainNode).connect(this.audioDestination)),i.element=h,this.streams.push(i),1==this.autoMode&&(this.resizeAndSortV2(),h.onloadedmetadata=()=>{if(console.debug("streamId = "+i.streamId),t.getVideoTracks()[0].getSettings().height>t.getVideoTracks()[0].getSettings().width){console.debug("portrait mode");let t=(i.width-this.pwidth)/2;i.portrait=!0,i.x+=t,i.width=this.pwidth,i.height=this.pheight,console.log("Location offset from metadata x = "+i.x+" y = "+i.y)}})}requestAnimationFrameV2(t){let e=!1;const i=setInterval((()=>{!e&&document.hidden&&(e=!0,clearInterval(i),t())}),1e3/this.fps);requestAnimationFrame((()=>{e||(e=!0,clearInterval(i),t())}))}resizeAndSortV2(){this.ctx.clearRect(0,0,this.width,this.height),console.log("Sorting the streams");let t=0,e=0,i=0,h=0,s=0,a=0,o=this.streams.length,r=0,n=0,d=0;var l=0,g=0;for(let t=1;t<=5;t++)if(this.streams.length<=t*t){if(d=t,t*(t-1)>=this.streams.length&&this.streams.length>2){if(i=t-1,this.height=this.stream_height*i,"16:9"==this.aspectRatio){let t=this.stream_height/9*16;this.width=t*i}else{let t=this.stream_height/3*4;this.width=t*i}l=this.stream_height*i,g="16:9"==this.aspectRatio?this.stream_height/16*9*i:this.stream_height/4*3*i}else{if(i=t,this.height=this.stream_height*i,"16:9"==this.aspectRatio){let t=this.stream_height/9*16;this.width=t*i}else{let t=this.stream_height/3*4;this.width=t*i}l=this.stream_height*i,g="16:9"==this.aspectRatio?this.stream_height/16*9*i:this.stream_height/4*3*i}break}this.canvas.setAttribute("width",this.width),this.canvas.setAttribute("height",this.height),console.log("Row number = "+i),console.log("canvas width = "+this.width+"canvas height = "+this.height);var m=this.streams.length-i*i;let c=0;for(let u=1;u<=this.streams.length;u++){console.log("extraStreams = "+m+" stream length = "+this.streams.length),console.log("Xindex = "+t+"Yindex = "+e);const w=this.streams[u-1];if(m<=0||this.streams.length<=3){if(this.pwidth=g/d,this.pheight=l/d,this.vwidth=this.width/d,this.vheight=this.height/d,1==w.portrait){w.width=this.pwidth,w.height=this.pheight,w.x=this.vwidth*t,w.y=this.vheight*e-n;let i=(this.vwidth-this.pwidth)/2;w.x+=i}else w.width=this.vwidth,w.height=this.vheight,w.x=this.vwidth*t,w.y=this.vheight*e-n;c+=this.width/d,console.log("Video width = "+w.width+"Video height = "+w.height),0==t&&(s+=w.height,console.debug("CropHeight = "+s)),t++,e>=i-1&&1!=this.streams.length&&(console.log("TopWidth = "+a+" remainingStreams = "+o),r=(a-this.vwidth*o)/2,w.x+=r),t>=i&&(t=0,a=c,c=0,e++,o-=i)}else{if(this.pwidth=g/(d+1),this.pheight=l/(d+1),this.vwidth=this.width/(d+1),this.vheight=this.height/(d+1),1==w.portrait){w.width=this.pwidth,w.height=this.pheight,w.x=this.vwidth*t,w.y=this.vheight*e;let i=(this.vwidth-this.pwidth)/2;w.x+=i}else w.width=this.vwidth,w.height=this.vheight,w.x=this.vwidth*t,w.y=this.vheight*e;h+=this.width/(d+1),console.log("Video Width = "+w.width+"VideoHeight = "+w.height),0==t&&(s+=w.height,console.debug("CropHeight = "+s)),t++,t>i&&(n=this.height/d-w.height,t=0,e++,r=this.width-h,this.canvas.setAttribute("width",h),console.log("New canvas width= "+h),a=h,h=0,m--,o-=i+1)}}this.canvas.setAttribute("height",s)}start(){this.started=!0,this.requestAnimationFrameV2(this.draw.bind(this)),this.result=this.canvas.captureStream(this.fps);const t=this.result.getAudioTracks()[0];t&&this.result.removeTrack(t);const e=this.audioDestination.stream.getAudioTracks();this.result.addTrack(e[0])}draw(){if(!this.started)return;this.frameCount++;let t=this.streams.length;const e=()=>{t--,t<=0&&this.requestAnimationFrameV2(this.draw.bind(this))};this.streams.forEach((t=>{const i=t.width,h=t.height;this.ctx.drawImage(t.element,t.x,t.y,i,h),e()})),0===this.streams.length&&e()}muteStream(t){for(let e=0;e<this.streams.length;e++){const i=this.streams[e];t===i.streamId&&(i.element&&0==i.mute?(i.audioGainNode.gain.value=0,i.mute=!0):i.element&&1==i.mute&&(i.audioGainNode.gain.value=1,i.mute=!1))}}removeStream(t){let e=!1;for(let i=0;i<this.streams.length;i++){const h=this.streams[i];t===h.streamId&&(h.element&&h.element.remove(),e=!0,this.streams[i]=null,this.streams.splice(i,1),i--)}console.log("removed streamId = "+t),1==this.autoMode&&this.resizeAndSortV2()}stop(){this.started=!1,this.streams.forEach((t=>{t.element&&t.element.remove()})),this.streams=[],this.audioCtx.close(),this.audioCtx=null,this.audioDestination=null,this.videoSyncDelayNode=null,this.result.getTracks().forEach((t=>{t.stop()})),this.result=null}}